
# coding: utf-8

# In[8]:

import pandas as pd
import numpy as np
from tia.bbg import datamgr as dm
import datetime
from pandas.tseries.offsets import BDay as bd
from tia.bbg import LocalTerminal
import wx


# In[65]:

def get_rundate(rundate=""):
    
    rundate =  rundate.iloc[0:1,0:1].to_dict()
    for col, row in rundate.items():
        for index, data in row.items():
            date = data
            date = date.replace("/","-")
            return date



class DataMgr(object):
    
    #rundate = input()
    
    def __init__(self, rundate, location, saveLoc):

        self.rundate = rundate
        self.location = location
        self.saveLoc = saveLoc

      
    def frame(self):
        
        #df = pd.read_csv(self.location+self.rundate+'.csv', delimiter='|')
        try:
            df = pd.read_csv(self.location+self.rundate+'.csv', delimiter='|')
            df = df[df['Master Account']!= 'TRADER']
            df = df[df['Parskeyeable Description'].astype(str)!='nan']
            return df
        except FileNotFoundError:
            pass
        try:
            df = pd.read_csv(self.location, sep="\t", skiprows=2)
            df = df[df['Master Account']!= 'TRADER']
            df = df[df['Parskeyeable Description'].astype(str)!='nan']
            df = df.iloc[:,:-1]
            return df
        except Exception as e:
            print(e)
            wx.MessageDialog(None, e, wx.OK).ShowModal()
            
    
    def secList(self):
        
        df = self.frame()
        unique = df['Parskeyeable Description'].unique()
        unique = [i for i in unique]
        return unique
    
    def bloomberg(self):
        
        securities = self.secList()
        df= self.frame()
        rundate = get_rundate(rundate=df)
        
        historical_data = LocalTerminal.get_historical(securities, ['PX_HIGH', 'PX_LOW'], start=rundate, end=rundate).as_frame()

        historical_bval = LocalTerminal.get_historical(securities, ['PX_ASK', 'PX_BID'], start=rundate, end=rundate,
                                                      PRICING_SOURCE='BVAL').as_frame()

        historical_bval = historical_bval.transpose().reset_index()
        historical_data = historical_data.transpose().reset_index()
        frames = [historical_bval, historical_data]
        frames = pd.concat(frames)
    
        
        
        hd=historical_data
        hb=historical_bval
        hdcols = ['bond', 'pcs', 'price']
        hd.columns = hdcols
        high = hd[hd['pcs'] =='PX_HIGH']
        high = high[['bond', 'price']]
        high.columns = ['bond', "PX_HIGH"]
        low = hd[hd['pcs'] =='PX_LOW']
        low = low[['bond', 'price']]
        low.columns = ['bond', "PX_LOW"]

        hbcols = ['bond', 'pcs', 'price']
        hb.columns = hbcols
        bid = hb[hb['pcs'] =='PX_BID']
        bid = bid[['bond', 'price']]
        bid.columns = ['bond', "PX_BID"]
        ask = hb[hb['pcs'] == 'PX_ASK']
        ask = ask[['bond', 'price']]
        ask.columns = ['bond', "PX_ASK"]        
    
        
        
        x = pd.merge(df, high, left_on = 'Parskeyeable Description', right_on = 'bond', how='inner')
        x = pd.merge(x, low, left_on = 'Parskeyeable Description', right_on = 'bond', how='inner')
        x = pd.merge(x, bid, left_on = 'Parskeyeable Description', right_on = 'bond', how='inner')
        x = pd.merge(x, ask, left_on = 'Parskeyeable Description', right_on = 'bond', how='inner')
        x = x[['As of Date', 'Ticket Number', 'Security Description', 'Trader Name',
            'Buy/Sell', 'TRADE FEED TRADE AMOUNT', 'Trade price',
           'TBLT Ticket Type', 'Cusip Number', 'Benchmark Cusip or Bloomberg',
           'Parskeyeable Description', 'Security Type', 'Trader Login',
           'Sales Login', 'Par Amount', 'Issue Date', 'Principal',
           'Market Sector Description', 'Identifier', 'Counterparty',
           'Master Account Long Name', 'Master Account',
           'Benchmark','Z-Spread','Benchmark Price','Factor', 'PX_ASK', 'PX_BID', 'PX_HIGH', 'PX_LOW']]
    
    
        bestEx = x
        bestEx['inside'] = np.where(bestEx['Buy/Sell']=='B',
                            np.where(bestEx['Trade price'] > bestEx['PX_LOW'], 'inside', 'outside'),
                            np.where(bestEx['Trade price'] < bestEx['PX_HIGH'], 'inside', 'outside'))



        bestEx['insideBidAsk'] = np.where(bestEx['PX_HIGH'].astype(str) == 'nan', #if this is true look for Buy sell code
                                          np.where(bestEx['Buy/Sell']=='B',
                                                   np.where(bestEx['Trade price'] > bestEx['PX_BID'], 'inside', 'outside'),
                                                   np.where(bestEx['Trade price'] < bestEx['PX_ASK'], 'inside', 'outside')),
                                          bestEx['inside'])
        
        bestEx['PX_HIGH_LOW_DIFF_%'] = np.where(bestEx['Buy/Sell'] == 'B',
                                     ((bestEx['Trade price']-bestEx['PX_LOW'])/bestEx['PX_LOW'])*100,
                                     ((bestEx['Trade price']-bestEx['PX_HIGH'])/bestEx['PX_HIGH'])*100)
        
        bestEx['PX_BID_ASK_DIFF_%'] = np.where(bestEx['Buy/Sell'] == 'B',
                                     ((bestEx['Trade price']- bestEx['PX_BID'])/bestEx['PX_BID'])*100,
                                     ((bestEx['Trade price']-bestEx['PX_ASK'])/bestEx['PX_ASK'])*100)
        
        return bestEx
        
        return historical_data
    
    def save(self):
        frame = self.bloomberg()
        return frame.to_excel(self.saveLoc+self.rundate+'.xlsx')

def main():
    pass

if __name__ == "__main__":
   # stuff only to run when not called via 'import' here
   main()